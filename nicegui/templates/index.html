<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <meta name="viewport" content="{{ viewport }}" />
    <link href="{{ favicon_url }}" rel="shortcut icon" />
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/nicegui.css" rel="stylesheet" type="text/css" />
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/fonts.css" rel="stylesheet" type="text/css" />
    {% if prod_js %}
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.prod.css" rel="stylesheet" type="text/css" />
    {% else %}
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.css" rel="stylesheet" type="text/css" />
    {% endif %}
    <!-- prevent Prettier from removing this line -->
    {{ head_html | safe }}
    <script type="importmap">
      {"imports": {{ imports | safe }}}
    </script>
    {% for url in js_imports_urls %}
    <link rel="modulepreload" href="{{ url }}" />
    {% endfor %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/socket.io.min.js"></script>
    <script>
      function createRandomUUID() {
        try {
          return crypto.randomUUID();
        } catch (e) {
          // https://stackoverflow.com/a/2117523/3419103
          return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, (c) =>
            (+c ^ (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (+c / 4)))).toString(16)
          );
        }
      }

      const OLD_TAB_ID = sessionStorage.__nicegui_tab_closed === "false" ? sessionStorage.__nicegui_tab_id : null;
      const TAB_ID =
        !sessionStorage.__nicegui_tab_id || sessionStorage.__nicegui_tab_closed === "false"
          ? (sessionStorage.__nicegui_tab_id = createRandomUUID())
          : sessionStorage.__nicegui_tab_id;
      sessionStorage.__nicegui_tab_closed = "false";
      window.onbeforeunload = function () {
        sessionStorage.__nicegui_tab_closed = "true";
      };

      function initSocketIO(options) {
        // Initialize window variables needed for socket communication
        window.documentId = createRandomUUID();
        window.clientId = options.query.client_id;
        window.path_prefix = options.prefix;
        window.nextMessageId = options.query.next_message_id;
        window.ackedMessageId = -1;

        // Initialize Socket.IO early
        const url = window.location.protocol === "https:" ? "wss://" : "ws://" + window.location.host;
        window.socket = io(url, {
          path: `${options.prefix}/_nicegui_ws/socket.io`,
          query: options.query,
          extraHeaders: options.extraHeaders,
          transports: options.transports,
        });
        window.did_handshake = false;
        window.socket.connect();
        console.log("Socket.IO connected");

        // Queue for messages received before the app is mounted
        window.premountMessageQueue = [];
        window.catchAllHandler = (event, ...args) => {
          if (args.length > 0 && args[0]._id !== undefined) {
            const message_id = args[0]._id;
            if (message_id < window.nextMessageId) return;
            window.nextMessageId = message_id + 1;
            delete args[0]._id;
          }
          premountMessageQueue.push({ event, args });
        };
        window.socket.onAny(window.catchAllHandler); // onAny does not cover "connect", though
        window.socket.on("connect", handleConnect);
      }

      function handleConnect() {
        if (window.documentId === undefined) { throw new Error("documentId is undefined. You're calling this too early!"); }
        const args = {
          client_id: window.clientId,
          document_id: window.documentId,
          tab_id: TAB_ID,
          old_tab_id: OLD_TAB_ID,
          next_message_id: window.nextMessageId,
        };
        window.socket.emit("handshake", args, (ok) => {
          if (!ok) {
            console.log("reloading because handshake failed for clientId " + window.clientId);
            window.location.reload();
          }
          // document.getElementById("popup").ariaHidden = true;
        });
        window.did_handshake = true;
      }

      window.nicegui_options = {
        version: "{{ version }}",
        prefix: "{{ prefix | safe }}",
        query: {{ socket_io_js_query_params | safe }},
        extraHeaders: {{ socket_io_js_extra_headers | safe }},
        transports: {{ socket_io_js_transports | safe }},
        quasarConfig: {{ quasar_config | safe }},
      }
      initSocketIO(window.nicegui_options);
    </script>
  </head>
  <body>
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/es-module-shims.js"></script>
    {% if tailwind %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/tailwindcss.min.js"></script>
    {% endif %}
    <!-- prevent Prettier from removing this line -->
    {% if prod_js %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/vue.global.prod.js"></script>
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.umd.prod.js"></script>
    {% else %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/vue.global.js"></script>
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.umd.js"></script>
    {% endif %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/nicegui.js"></script>

    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/lang/{{ language }}.umd.prod.js"></script>
    {{ body_html | safe }}

    <div id="app"></div>
    <div id="popup" aria-hidden="true">
      <span>{{ translations.connection_lost }}</span>
      <span>{{ translations.trying_to_reconnect }}</span>
    </div>
    <script type="module">
      const app = createApp(parseElements(String.raw`{{ elements | safe }}`), window.nicegui_options);
      console.log("After createApp");

      {{ js_imports | safe }}

      console.log("After js_imports");

      {{ vue_scripts | safe }}

      console.log("After vue_scripts");

      const dark = {{ dark }};
      Quasar.lang.set(Quasar.lang["{{ language }}".replace('-', '')]);
      Quasar.Dark.set(dark === None ? "auto" : dark);
      {% if tailwind %}
      if (dark !== None) tailwind.config.darkMode = "class";
      if (dark === True) document.body.classList.add("dark");
      {% endif %}

      app.mount("#app");
    </script>
  </body>
</html>
