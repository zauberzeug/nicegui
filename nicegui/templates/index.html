<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <meta name="viewport" content="{{ viewport }}" />
    <link href="{{ favicon_url }}" rel="shortcut icon" />
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/nicegui.css" rel="stylesheet" type="text/css" />
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/fonts.css" rel="stylesheet" type="text/css" />
    {% if prod_js %}
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.prod.css" rel="stylesheet" type="text/css" />
    {% else %}
    <link href="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.css" rel="stylesheet" type="text/css" />
    {% endif %}
    <!-- prevent Prettier from removing this line -->
    {{ head_html | safe }}
  </head>
  <body>
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/es-module-shims.js"></script>
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/socket.io.min.js"></script>
    {% if tailwind %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/tailwindcss.min.js"></script>
    {% endif %}
    <!-- prevent Prettier from removing this line -->
    {% if prod_js %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/vue.global.prod.js"></script>
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.umd.prod.js"></script>
    {% else %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/vue.global.js"></script>
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/quasar.umd.js"></script>
    {% endif %}
    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/nicegui.js"></script>

    <script src="{{ prefix | safe }}/_nicegui/{{version}}/static/lang/{{ language }}.umd.prod.js"></script>
    <script type="importmap">
      {"imports": {{ imports | safe }}}
    </script>
    {{ body_html | safe }}

    <div id="app"></div>
    <div id="popup">
      <span>Connection lost.</span>
      <span>Trying to reconnect...</span>
    </div>
    <script type="module">
      const prefix = "{{ prefix | safe }}";
      const version = "{{ version }}";
      const raw_elements = String.raw`{{ elements | safe }}`;
      const elements = JSON.parse(raw_elements.replace(/&#36;/g, '$')
                                              .replace(/&#96;/g, '`')
                                              .replace(/&gt;/g, '>')
                                              .replace(/&lt;/g, '<')
                                              .replace(/&amp;/g, '&'));

      let app = Vue.createApp({
        data() {
          return {
            elements,
          };
        },
        render() {
          return renderRecursively(this.elements, 0);
        },
        mounted() {
          window.app = this;
          const query = {{ socket_io_js_query_params | safe }};
          window.client_id = query.client_id;
          const url = window.location.protocol === 'https:' ? 'wss://' : 'ws://' + window.location.host;
          const extraHeaders = {{ socket_io_js_extra_headers | safe }};
          const transports = {{ socket_io_js_transports | safe }};
          window.path_prefix = "{{ prefix | safe }}";
          window.socket = io(url, { path: "{{ prefix | safe }}/_nicegui_ws/socket.io", query, extraHeaders, transports });
          const messageHandlers = {
            connect: () => {
              window.socket.emit("handshake", window.client_id, (ok) => {
                if (!ok) {
                  console.log('reloading because handshake failed for client_id ' + window.client_id)
                  window.location.reload();
                }
                document.getElementById('popup').style.opacity = 0;
              });
            },
            connect_error: (err) => {
              if (err.message == 'timeout') {
                console.log('reloading because connection timed out')
                window.location.reload(); // see https://github.com/zauberzeug/nicegui/issues/198
              }
            },
            try_reconnect: async () => {
              document.getElementById('popup').style.opacity = 1;
              await fetch(window.location.href, { headers: { 'NiceGUI-Check': 'try_reconnect' } });
              console.log('reloading because reconnect was requested')
              window.location.reload();
            },
            disconnect: () => {
              document.getElementById('popup').style.opacity = 1;
            },
            update: async (msg) => {
              for (const [id, element] of Object.entries(msg)) {
                if (element === null) {
                  delete this.elements[id];
                  continue;
                }
                if (element.component || element.libraries) {
                  await loadDependencies(element, prefix, version, app);
                }
                this.elements[id] = element;
              }
            },
            run_javascript: (msg) => runJavascript(msg['code'], msg['request_id']),
            open: (msg) => {
              const url = msg.path.startsWith('/') ? "{{ prefix | safe }}" + msg.path : msg.path;
              const target = msg.new_tab ? '_blank' : '_self';
              window.open(url, target);
            },
            download: (msg) => download(msg.src, msg.filename, msg.media_type, prefix),
            notify: (msg) => Quasar.Notify.create(msg),
          };
          const socketMessageQueue = [];
          let isProcessingSocketMessage = false;
          for (const [event, handler] of Object.entries(messageHandlers)) {
            window.socket.on(event, async (...args) => {
              socketMessageQueue.push(() => handler(...args));
              if (!isProcessingSocketMessage) {
                while (socketMessageQueue.length > 0) {
                  const handler = socketMessageQueue.shift()
                  isProcessingSocketMessage = true;
                  try {
                    await handler();
                  }
                  catch (e) {
                    console.error(e);
                  }
                  isProcessingSocketMessage = false;
                }
              }
            });
          }
        },
      }).use(Quasar, {
        config: {{ quasar_config | safe }}
      });

      {{ js_imports | safe }}
      {{ vue_scripts | safe }}

      const dark = {{ dark }};
      Quasar.lang.set(Quasar.lang["{{ language }}".replace('-', '')]);
      Quasar.Dark.set(dark === None ? "auto" : dark);
      {% if tailwind %}
      if (dark !== None) tailwind.config.darkMode = "class";
      if (dark === True) document.body.classList.add("dark");
      {% endif %}

      app.mount("#app");
    </script>
  </body>
</html>
